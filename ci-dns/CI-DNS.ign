{"ignition":{"config":{},"security":{"tls":{}},"timeouts":{},"version":"2.2.0"},"networkd":{},"passwd":{"users":[{"name":"core","sshAuthorizedKeys":["ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA1qB1X9H9wDTT5J88nfeXtHBPAaRyIqe2rnF7bgqc4wpXpdSoxOX18K/45tT9sYOHU/63DfmQdpqUPso3Ql3uBzzW78np4Qa6HlGTynpOSqn7J3UwFdMD0/5EocqsEYfdQsjHCYT2arGvBWT2b4huxq9ke2WqXKUVEbZHpgSrR9dGQrM8xL1vmF5wcVTS6f5W0vq/x7YlJiIKtWUplV302DVFeLAXiDA+f6cVcd4q3NI07Py00sOU3YI3jYpPWxTMTj2R5k1bn+CbXqi5RfV/L+JLXq4XCAT7b/mHkSsXZC7Kn6s92oY930U5dSaYSZWVz54Q9wwOZYmdAoOKsGwwiQ== m.andre@redhat.com","ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA1HTJjdVoE1+O5Qieh4KvT3wHUP85lZzYTfaeE0tBdeHvSKZDonQQfYoMzkdwKEfV8Bgivd8nAYDZnFKqTF2rLvQkB4XuuZYdzwJEiXmW3GQpu3xTFDA9KdLfbuYqW/IlbjaGT5TiFSmDDErzhwlz2T5xKd2PsHM+URpctSgYlcIZPeW7Gj02dyyqF6TPJ93/VQEtBhLCwSh4cZOA+bkV0ghgcD6tyqyiM3MSrldEdy7098xXrOW0Lz1luHK+p5/vVsS2Uowd7yVAcFuHaG4/YTDpg/zIWdH/WJ85k4Pq2BmEwKr5G+Zmnqo4h17gfwaxPJtL9UorLSuaA/l5RPt7cQ== tsedovic@redhat.com","ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDsboPPbyMRqyh1mchlrX8t3jHp6MWaOm6DEA55PJ8YwSHbzgabU8x/X6fXYIppne0570cvtQW4NZyURWjb6y5AANwRtNOVz5lsxC0tgPLOMKzyopG/fZc8tsqH0rMzwPghEIH4a7XK16MDCyOdK5va3S3VVupCo5SYjimxYBC1EinXG3brhYe7500S0E/U8hn+26W2f2o8bS2Z3KoUweAsyENVXH5Y/m+ia5g2JbUa132AVEtWnhhQpbZkskpbr2MqsjpBIchOp5mOfqElEGzeRjjn2Kd8yZov11cKKeYwGoKSPQHvjK6E1t+LYRA1UxTmyNy4M4gPfIBncDm3pHIz egarcia@emilio","ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA+yNMzUrQXa0EOfv+WJtfmLO1WdoOaD47G9qwllSUc4GPRkYzkTNdxcEPrR3XBR94ctOeWOHZ/w7ymhvwK5LLsoNBK+WgRz/mg8oHcii2GoL0fNojdwUMyFMIJxJT+iwjF/omyhyrW/aLAztAKRO7BdOkNlXMAAcMxKzQtFqdZm09ghoImu3BPYUTyDKHMp+t0P1d7mkHdd719oDfMf+5miHxQeJZJCWAsGwroN7k8a46rvezDHEygBsDAF2ZpS2iGMABos/vTp1oyHkCgCqc3rM0OoKqcKB5iQ9Qaqi5ung08BXP/PHfVynXzdGMjTh4w+6jiMw7Dx2GrQIJsDolKQ== dprince@redhat.com","ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCpE2mGXMLZLBpWYMhO1Kz85FryqgD9zGStgTrY1x1Fspyjk4la9v2AYWsTCLISlNne3CdhaRmKjhYo7xdW9px8JCbPwtXqbCjOEuKsuHCtlbn+6ubZsJaYkImYAq3EEsi0cXMUCutrMPzMZaMCiaTIUhOXj+f1GY6zqVZlK2thJO9tzj5vAx1leWlwdn6CBM7ikXCQ6PVvqofki2pdV7V/HF3dmNCg1196/o8yH5x+ItithPJCvXytlIzi+5jy7YqGnei5jDUzqf0ZMS2OnJ7IkTz3vx322g3SUET/lYoFO5bjYbhAsLc83WM4Yvaw9FCEZCzKxMBQXK91oGH5siHT mfedosin@redhat.com","ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC/Zc+pyRoKWVS1CVx2soRe7Ia7RGkASpXZE495H2XuS3gF4Vb9JdATkJ4NURmAQhUN8TYCbfqTcf2Fpm/5mtG6Dn8Avua1mXgNRvrufVYBvWkOn9qPEYkwELSG0WcqjpISwsKRAU0d7Mcqo0aDmp/wpgbXHCBG03Q8w0uhRTdI7jEj/EzatbtkgUJnE79OHUImxdG+11oKH0Ul2lQlSo+pMa0fwS3GrHKIxxZmMckSpT+gua0AttuGpr+JYIZKNkoWn7bMqpYpJAlKxjzaB6ympaIAOgd/CxXnXPzc8ntIm/MubDUbGzo7dpq39MmxtWb1bahS/zeyFq0ZR43FbHexZyj21PiurtFOXl93r+wgBLBcVjBogi23p8i+SrjOVb+nJJ5XEUaLDYYE7T4xnrmT/T0ODQQbh6W+F+/mCSwOpRsZV0+FYcWg34InQM177eBweAv5Lwtct6B0xzCCXYpNTjWpBUe46dP7FO0ltzD57CGglRyx7whff96Og7Zx61/YfR/zrfI4NYiP+4EbiN24NuTn0DvND/anCpvA1Zpsd7bNMvL9YrlCRD2lfcQl3p6Kqi48jLNpqjEMYEmgYzzGjE1hFuVqdjY63bAmD3+NPlfARsgbMiPpLAmb3nE5FTCWktUTE8fnoWIojUYm7/4HoVQlwWxRhLKji5NiJGMgYw== pprinett@redhat.com"]}]},"storage":{"files":[{"filesystem":"root","path":"/etc/iptables.rules","contents":{"source":"data:,*filter%0A%3AINPUT%20ACCEPT%20%5B0%3A0%5D%0A%3AFORWARD%20ACCEPT%20%5B0%3A0%5D%0A%3AOUTPUT%20ACCEPT%20%5B0%3A0%5D%0A-A%20INPUT%20-p%20udp%20--dport%2053%20-s%20192.168.23.0%2F24%20-j%20ACCEPT%20-m%20comment%20--comment%20%22accept%20DNS%20queries%20from%20internal%20network%22%0A-A%20INPUT%20-p%20udp%20--dport%2053%20-j%20DROP%20-m%20comment%20--comment%20%22drop%20all%20DNS%20queries%20from%20outside%22%0ACOMMIT%0A","verification":{}},"mode":420},{"filesystem":"root","path":"/etc/coredns/dynamic-update.py","contents":{"source":"data:,import%20http.server%0Aimport%20json%0Aimport%20logging%0Aimport%20os%0A%0A%23%20Edit%20these%20to%20suit%20your%20needs%3A%0APORT%20%3D%208080%0ADOMAIN%20%3D%20%22shiftstack.ci%22%0ACOREDB_FILE%20%3D%20%22%2Fetc%2Fcoredns%2Fdb.%7B%7D%22.format(DOMAIN)%0ALOG_FILE%20%3D%20%22%2Fvar%2Flog%2Fdynamic-dns-updater.log%22%0A%0A%0A%23%20You%20should%20probably%20not%20touch%20these%20unless%20you%20want%20to%20hardcode%20some%20records%0ACOREDB_TEMPLATE%20%3D%20%22%22%22%0A%24ORIGIN%20%7Bdomain%7D.%0A%40%20%20%20%203600%20IN%20SOA%20%7Bdomain%7D.%20hostmaster%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7Bserial%7D%20%3B%20serial%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%207200%20%20%20%20%20%20%20%3B%20refresh%20(2%20hours)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%203600%20%20%20%20%20%20%20%3B%20retry%20(1%20hour)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%201209600%20%20%20%20%3B%20expire%20(2%20weeks)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%203600%20%20%20%20%20%20%20%3B%20minimum%20(1%20hour)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%7Bentries%7D%0A%22%22%22%0AENTRIES%20%3D%20%7B%7D%0ASERIAL_NUMBER%20%3D%200%0A%0A%0Adef%20build_coredb_file(domain%2C%20serial_number%2C%20entries)%3A%0A%20%20%20%20formatted_entries%20%3D%20'%5Cn'.join(%22%7B%7D%20IN%20A%20%7B%7D%22.format(name%2C%20ip)%20for%20name%2C%20ip%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20in%20entries.items())%0A%20%20%20%20return%20COREDB_TEMPLATE.format(domain%3Ddomain%2C%20serial%3Dserial_number%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20entries%3Dformatted_entries)%0A%0A%0Aclass%20ServerHandler(http.server.SimpleHTTPRequestHandler)%3A%0A%20%20%20%20def%20do_POST(self)%3A%0A%20%20%20%20%20%20%20%20content_len%20%3D%20int(self.headers.get('content-length'%2C%200))%0A%20%20%20%20%20%20%20%20post_body%20%3D%20self.rfile.read(content_len)%0A%20%20%20%20%20%20%20%20body%20%3D%20%22%22%0A%20%20%20%20%20%20%20%20client_address%20%3D%20self.client_address%5B0%5D%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20body%20%3D%20json.loads(post_body)%0A%20%20%20%20%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.send_response(422)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.end_headers()%0A%20%20%20%20%20%20%20%20%20%20%20%20logging.warning(%22Invalid%20JSON%20from%20%7B%7D%22.format(client_address))%0A%20%20%20%20%20%20%20%20%20%20%20%20return%0A%20%20%20%20%20%20%20%20self.send_response(200)%0A%20%20%20%20%20%20%20%20self.end_headers()%0A%0A%20%20%20%20%20%20%20%20if%20self.path%20%3D%3D%20%22%2Fadd%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.process_add(body%2C%20client_address)%0A%20%20%20%20%20%20%20%20elif%20self.path%20%3D%3D%20%22%2Fremove%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.process_remove(body%2C%20client_address)%0A%0A%20%20%20%20def%20write_db_file(self)%3A%0A%20%20%20%20%20%20%20%20global%20ENTRIES%0A%20%20%20%20%20%20%20%20global%20SERIAL_NUMBER%0A%20%20%20%20%20%20%20%20global%20DOMAIN%0A%20%20%20%20%20%20%20%20SERIAL_NUMBER%20%2B%3D%201%0A%20%20%20%20%20%20%20%20db%20%3D%20build_coredb_file(DOMAIN%2C%20SERIAL_NUMBER%2C%20ENTRIES)%0A%20%20%20%20%20%20%20%20logging.info(%22Writing%20version%20%7B%7D%20to%20file%20%7B%7D%22.format(SERIAL_NUMBER%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20COREDB_FILE))%0A%20%20%20%20%20%20%20%20with%20open(COREDB_FILE%2C%20'w')%20as%20f%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20f.write(db)%0A%0A%20%20%20%20def%20iptables_rule(self%2C%20address%2C%20comment)%3A%0A%20%20%20%20%20%20%20%20return%20%22INPUT%20-p%20udp%20--dport%2053%20-j%20ACCEPT%20-s%20%7B%7D%20%22%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22-m%20comment%20--comment%20'%7B%7D'%22.format(address%2C%20comment)%0A%0A%20%20%20%20def%20add_iptables_rule(self%2C%20address%2C%20comment)%3A%0A%20%20%20%20%20%20%20%20rule%20%3D%20self.iptables_rule(address%2C%20comment)%0A%20%20%20%20%20%20%20%20self.ensure_iptables_rule(%22insert%22%2C%20rule)%0A%0A%20%20%20%20def%20remove_iptables_rule(self%2C%20address%2C%20comment)%3A%0A%20%20%20%20%20%20%20%20rule%20%3D%20self.iptables_rule(address%2C%20comment)%0A%20%20%20%20%20%20%20%20self.ensure_iptables_rule(%22delete%22%2C%20rule)%0A%0A%20%20%20%20def%20ensure_iptables_rule(self%2C%20command%2C%20rule)%3A%0A%20%20%20%20%20%20%20%20%23%20iptables%20--check%20returns%200%20if%20the%20rule%20exists%0A%20%20%20%20%20%20%20%20%23%20It%20also%20generates%20harmless%20%22iptables%3A%20Bad%20rule%20(does%20a%20matching%20rule%0A%20%20%20%20%20%20%20%20%23%20exist%20in%20that%20chain%3F).%22%20comments%20in%20the%20logs%20when%20the%20rule%20does%20not%0A%20%20%20%20%20%20%20%20%23%20yet%20exist.%0A%20%20%20%20%20%20%20%20if%20(command%20%3D%3D%20'insert'%20and%0A%20%20%20%20%20%20%20%20%20%20os.system(%22%2Fsbin%2Fiptables%20--check%20%7B%7D%22.format(rule))%20%3D%3D%200)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%0A%0A%20%20%20%20%20%20%20%20os.system(%22%2Fsbin%2Fiptables%20--%7B%7D%20%7B%7D%22.format(command%2C%20rule))%0A%0A%20%20%20%20def%20process_add(self%2C%20body%2C%20client_address)%3A%0A%20%20%20%20%20%20%20%20global%20ENTRIES%0A%20%20%20%20%20%20%20%20if%20body.get('cluster_name')%20and%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(body.get('lb_fip')%20or%20body.get('apps_fip'))%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20logging.info(%22Adding%20entries%20for%20%7B%7D%22.format(body%5B'cluster_name'%5D))%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20body.get('lb_fip')%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ENTRIES%5B%22api.%7B%7D%22.format(body%5B'cluster_name'%5D)%5D%20%3D%20body%5B'lb_fip'%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20body.get('apps_fip')%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ENTRIES%5B%22*.apps.%7B%7D%22.format(body%5B'cluster_name'%5D)%5D%20%3D%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20body%5B'apps_fip'%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20self.write_db_file()%0A%20%20%20%20%20%20%20%20%20%20%20%20self.add_iptables_rule(client_address%2C%20body%5B'cluster_name'%5D)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20logging.warning(%22Invalid%20JSON%20from%20%7B%7D%22.format(client_address))%0A%0A%20%20%20%20def%20process_remove(self%2C%20body%2C%20client_address)%3A%0A%20%20%20%20%20%20%20%20global%20ENTRIES%0A%20%20%20%20%20%20%20%20if%20body.get('cluster_name')%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20%22api.%7B%7D%22.format(body%5B'cluster_name'%5D)%20in%20ENTRIES%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20del%20ENTRIES%5B%22api.%7B%7D%22.format(body%5B'cluster_name'%5D)%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20%22*.apps.%7B%7D%22.format(body%5B'cluster_name'%5D)%20in%20ENTRIES%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20del%20ENTRIES%5B%22*.apps.%7B%7D%22.format(body%5B'cluster_name'%5D)%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20logging.info(%22Removing%20entries%20for%20%7B%7D%22.format(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20body%5B'cluster_name'%5D))%0A%20%20%20%20%20%20%20%20%20%20%20%20self.write_db_file()%0A%20%20%20%20%20%20%20%20%20%20%20%20self.remove_iptables_rule(client_address%2C%20body%5B'cluster_name'%5D)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20logging.warning(%22Invalid%20JSON%20from%20%7B%7D%22.format(client_address))%0A%0A%0Aif%20__name__%20%3D%3D%20'__main__'%3A%0A%20%20%20%20logging.basicConfig(filename%3DLOG_FILE%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20format%3D'%25(asctime)s%20-%20%25(levelname)s%20-%20%25(message)s'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20level%3Dlogging.DEBUG)%0A%20%20%20%20with%20http.server.HTTPServer((%22%22%2C%20PORT)%2C%20ServerHandler)%20as%20httpd%3A%0A%20%20%20%20%20%20%20%20logging.info(%22Serving%20at%20port%20%25s%22%2C%20PORT)%0A%20%20%20%20%20%20%20%20httpd.serve_forever()%0A","verification":{}},"mode":420},{"filesystem":"root","path":"/etc/coredns/Corefile","contents":{"source":"data:,.%20%7B%0A%20%20%20%20log%0A%20%20%20%20errors%0A%0A%20%20%20%20forward%20.%20%2Fetc%2Fresolv.conf%20%7B%0A%20%20%20%20%20%20%20%20except%20shiftstack.ci%0A%20%20%20%20%7D%0A%7D%0A%0Ashiftstack.ci%20%7B%0A%20%20%20%20log%0A%20%20%20%20errors%0A%0A%20%20%20%20file%20%2Fetc%2Fcoredns%2Fdb.shiftstack.ci%20%7B%0A%20%20%20%20%20%20%20%20reload%2010s%0A%20%20%20%20%7D%0A%7D%0A","verification":{}},"mode":420},{"filesystem":"root","path":"/etc/coredns/db.shiftstack.ci","contents":{"source":"data:,%24ORIGIN%20shiftstack.ci.%0A%40%20%20%20%203600%20IN%20SOA%20dns.shiftstack.ci.%20hostmaster%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%202017042752%20%3B%20serial%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%207200%20%20%20%20%20%20%20%3B%20refresh%20(2%20hours)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%203600%20%20%20%20%20%20%20%3B%20retry%20(1%20hour)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%201209600%20%20%20%20%3B%20expire%20(2%20weeks)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%203600%20%20%20%20%20%20%20%3B%20minimum%20(1%20hour)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A","verification":{}},"mode":420}]},"systemd":{"units":[{"contents":"[Unit]\nDescription=Firewall\nAfter=network.target\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=/bin/sh -c \"/sbin/iptables-restore \u003c /etc/iptables.rules\"\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"iptables.service"},{"contents":"[Unit]\nDescription=CI DNS\n\n[Service]\nExecStart=/bin/podman run --rm -i -t -m 128m --net host --cap-add=NET_ADMIN -v /etc/coredns:/etc/coredns:Z openshift/origin-coredns:v4.0 -conf /etc/coredns/Corefile\nRestart=always\nRestartSec=10\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"ci-dns.service"},{"contents":"[Unit]\nDescription=Dynamic DNS updater\n\n[Service]\nExecStart=/usr/libexec/platform-python /etc/coredns/dynamic-update.py\nRestart=always\nRestartSec=10\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"dynamic-dns-updater.service"}]}}