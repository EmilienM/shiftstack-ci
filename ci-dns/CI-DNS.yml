passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA1qB1X9H9wDTT5J88nfeXtHBPAaRyIqe2rnF7bgqc4wpXpdSoxOX18K/45tT9sYOHU/63DfmQdpqUPso3Ql3uBzzW78np4Qa6HlGTynpOSqn7J3UwFdMD0/5EocqsEYfdQsjHCYT2arGvBWT2b4huxq9ke2WqXKUVEbZHpgSrR9dGQrM8xL1vmF5wcVTS6f5W0vq/x7YlJiIKtWUplV302DVFeLAXiDA+f6cVcd4q3NI07Py00sOU3YI3jYpPWxTMTj2R5k1bn+CbXqi5RfV/L+JLXq4XCAT7b/mHkSsXZC7Kn6s92oY930U5dSaYSZWVz54Q9wwOZYmdAoOKsGwwiQ== m.andre@redhat.com
storage:
  files:
    - path: /etc/coredns/dynamic-update.py
      filesystem: root
      mode: 0644
      contents:
        inline: |
          import http.server
          import socketserver
          import json
     
          # Edit these to suit your needs:
          PORT = 8080
          DOMAIN = "shiftstack.ci"
          COREDB_FILE = "/etc/coredns/db.{}".format(DOMAIN)
     
     
          # You should probably not touch these unless you want to hardcode some records
          COREDB_TEMPLATE = """
          $ORIGIN {domain}.
          @    3600 IN SOA {domain}. hostmaster (
                                          {serial} ; serial
                                          7200       ; refresh (2 hours)
                                          3600       ; retry (1 hour)
                                          1209600    ; expire (2 weeks)
                                          3600       ; minimum (1 hour)
                                          )
     
          {entries}
          """
          ENTRIES = {}
          SERIAL_NUMBER = 0
     
     
          def build_coredb_file(domain, serial_number, entries):
              formatted_entries = '\n'.join("{} IN A {}".format(name, ip) for name, ip
                  in entries.items())
              return COREDB_TEMPLATE.format(domain=domain, serial=serial_number,
                  entries=formatted_entries)
     
     
          class ServerHandler(http.server.SimpleHTTPRequestHandler):
              def do_POST(self):
                  global ENTRIES
                  global SERIAL_NUMBER
                  global DOMAIN
                  content_len = int(self.headers.get('content-length', 0))
                  post_body = self.rfile.read(content_len)
                  body = ""
                  try:
                      body = json.loads(post_body)
                  except Exception:
                      self.send_response(422)
                      print("Error, invalid JSON: {}".format(post_body))
                      return
                  self.send_response(200)
                  if 'name' in body and 'ip' in body:
                      ENTRIES[body['name']] = body['ip']
                      SERIAL_NUMBER += 1
                      db = build_coredb_file(DOMAIN, SERIAL_NUMBER, ENTRIES)
                      print("Writing version {} to file {}".format(SERIAL_NUMBER, COREDB_FILE))
                      with open(COREDB_FILE, 'w') as f:
                          f.write(db)
                  else:
                      print("Invalid format of body", repr(body))
     
     
          if __name__ == '__main__':
              Handler = ServerHandler
              httpd = socketserver.TCPServer(("", PORT), Handler)
              print("serving at port", PORT)
              httpd.serve_forever()

    - path: /etc/coredns/Corefile
      filesystem: root
      mode: 0644
      contents:
        inline: |
          . {
              log
              errors

              forward . /etc/resolv.conf {
                  except shiftstack.ci
              }
          }

          shiftstack.ci {
              log
              errors

              file /etc/coredns/db.shiftstack.ci {
                  reload 10s
              }
          }

    - path: /etc/coredns/db.shiftstack.ci
      filesystem: root
      mode: 0644
      contents:
        inline: |
          $ORIGIN shiftstack.ci.
          @    3600 IN SOA dns.shiftstack.ci. hostmaster (
                                          2017042752 ; serial
                                          7200       ; refresh (2 hours)
                                          3600       ; retry (1 hour)
                                          1209600    ; expire (2 weeks)
                                          3600       ; minimum (1 hour)
                                          )


systemd:
  units:
    - name: ci-dns.service
      enabled: true
      contents: |
        [Unit]
        Description=CI DNS

        [Service]
        ExecStart=/bin/podman run --rm -i -t -m 128m --net host --cap-add=NET_ADMIN -v /etc/coredns:/etc/coredns:Z openshift/origin-coredns:v4.0 -conf /etc/coredns/Corefile
        Restart=always
        RestartSec=10

        [Install]
        WantedBy=multi-user.target
    - name: dynamic-dns-updater.service
      enabled: true
      contents: |
        [Unit]
        Description=Dynamic DNS updater

        [Service]
        ExecStart=/usr/libexec/platform-python /etc/coredns/dynamic-update.py
        Restart=always
        RestartSec=10

        [Install]
        WantedBy=multi-user.target
